<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pill Assistant</title>
    <link rel="icon" href="data:,">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: 100%;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--primary-background-color, #fafafa);
            color: var(--primary-text-color, #212121);
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            min-height: 100vh;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            touch-action: pan-y;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 20px;
            color: var(--primary-color, #03a9f4);
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .add-medication-btn {
            background-color: var(--primary-color, #03a9f4);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .add-medication-btn:hover {
            background-color: var(--dark-primary-color, #0288d1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }

        .add-medication-btn:active {
            transform: translateY(0);
        }

        .medication-card {
            background: var(--card-background-color, #ffffff);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .medication-card.updating {
            opacity: 0.7;
            pointer-events: none;
        }

        .medication-card.updating::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
        }

        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--divider-color, #e0e0e0);
            padding-bottom: 10px;
        }

        .medication-name {
            font-size: 1.5em;
            font-weight: 500;
            color: var(--primary-text-color, #212121);
        }

        .medication-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-scheduled { background-color: #81c784; color: white; }
        .status-due { background-color: #ff9800; color: white; }
        .status-overdue { background-color: #f44336; color: white; }
        .status-taken { background-color: #4caf50; color: white; }
        .status-refill_needed { background-color: #9c27b0; color: white; }

        .medication-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            padding: 10px;
            background: var(--secondary-background-color, #f5f5f5);
            border-radius: 4px;
        }

        .detail-label {
            font-size: 0.85em;
            color: var(--secondary-text-color, #757575);
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--primary-text-color, #212121);
        }

        .dosage-adjuster {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--secondary-background-color, #f5f5f5);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            margin-right: 10px;
        }

        .dosage-label {
            font-weight: 500;
            font-size: 0.9em;
            margin-right: 4px;
        }

        .adjusters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .dosage-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dosage-btn {
            background: var(--primary-color, #03a9f4);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .dosage-btn:hover {
            background: var(--dark-primary-color, #0288d1);
        }

        .dosage-btn:disabled {
            background: var(--disabled-text-color, #9e9e9e);
            cursor: not-allowed;
        }

        .dosage-value {
            font-size: 1.1em;
            font-weight: 500;
            min-width: 80px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn-take {
            background: #4caf50;
            color: white;
        }

        .btn-take:hover {
            background: #45a049;
        }

        .btn-skip {
            background: #ff9800;
            color: white;
        }

        .btn-skip:hover {
            background: #f57c00;
        }

        .btn-refill {
            background: #9c27b0;
            color: white;
        }

        .btn-refill:hover {
            background: #7b1fa2;
        }

        .btn-test {
            background: #03a9f4;
            color: white;
        }

        .btn-test:hover {
            background: #0288d1;
        }

        .btn-edit {
            background: #2196f3;
            color: white;
        }

        .btn-edit:hover {
            background: #1976d2;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .card-management-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--divider-color, #e0e0e0);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: var(--secondary-text-color, #757575);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            padding: 15px 25px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--secondary-text-color, #757575);
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }

            .medication-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .medication-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .action-btn {
                min-width: 100%;
                width: 100%;
            }

            .adjusters-container {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }

            .dosage-adjuster {
                width: 100%;
                margin-right: 0;
            }

            .success-message,
            .error-message {
                left: 10px;
                right: 10px;
                top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>üíä Pill Assistant</h1>
            <button class="add-medication-btn" onclick="addMedication()">
                ‚ûï Add Medication
            </button>
        </div>
        <div id="content">
            <div class="loading">Loading medications...</div>
        </div>
    </div>

    <script>
        // Configuration constants
        const SUBSCRIPTION_MAX_ATTEMPTS = 10;
        const SUBSCRIPTION_BASE_DELAY_MS = 1000;
        const SUBSCRIPTION_MAX_DELAY_MS = 5000;
        const RELOAD_DELAY_MS = 100;
        const POLL_INTERVAL_MS = 30000;

        let hass = null;
        let medications = [];

        // Helper function to find medication card by ID
        function findMedicationCard(medId) {
            const cards = document.querySelectorAll('[data-entity-id]');
            for (const card of cards) {
                const entityId = card.getAttribute('data-entity-id');
                if (entityId && entityId.includes(medId)) {
                    // Verify it's an exact match by checking if it's the full entity ID
                    // Note: We check both 'Medication ID' (human-friendly display name) and 
                    // 'medication_id' (legacy technical name) for backward compatibility
                    const medication = medications.find(m => 
                        (m.attributes['Medication ID'] === medId || m.attributes['medication_id'] === medId)
                    );
                    if (medication && entityId === medication.entityId) {
                        return card;
                    }
                }
            }
            return null;
        }

        // Format time to local 12-hour format with AM/PM
        function formatTimeToLocal(timeStr) {
            if (!timeStr || timeStr === 'Never' || timeStr === 'Unknown' || timeStr === 'Not scheduled') {
                return timeStr;
            }
            
            try {
                // Try to parse as ISO datetime string
                let date = new Date(timeStr);
                
                // Check if it's a valid date
                if (isNaN(date.getTime())) {
                    // Try parsing HH:MM format
                    const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                        const hours = parseInt(timeMatch[1]);
                        const minutes = parseInt(timeMatch[2]);
                        const period = hours >= 12 ? 'PM' : 'AM';
                        const displayHours = hours % 12 || 12;
                        return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
                    }
                    return timeStr; // Return as-is if can't parse
                }
                
                // Format to local 12-hour time with AM/PM
                return date.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                console.warn('Error formatting time:', timeStr, e);
                return timeStr;
            }
        }

        // Format schedule to show times in local format
        function formatSchedule(schedule) {
            if (!schedule || schedule === 'Not scheduled') {
                return schedule;
            }
            
            // Parse times from schedule string (e.g., "08:00, 20:00 on mon, tue, wed, thu, fri, sat, sun")
            const timePattern = /(\d{1,2}:\d{2})/g;
            const times = schedule.match(timePattern);
            
            if (times && times.length > 0) {
                const formattedTimes = times.map(time => formatTimeToLocal(time));
                let result = schedule;
                times.forEach((time, i) => {
                    result = result.replace(time, formattedTimes[i]);
                });
                return result;
            }
            
            return schedule;
        }

        // Get Home Assistant connection
        function getHassConnection() {
            if (window.parent && window.parent.document) {
                const haElement = window.parent.document.querySelector('home-assistant');
                if (haElement && haElement.hass) {
                    return haElement.hass;
                }
            }
            return null;
        }

        // Initialize connection to Home Assistant
        let retryCount = 0;
        function initConnection() {
            hass = getHassConnection();
            if (hass) {
                loadMedications();
            } else {
                retryCount++;
                if (retryCount < 10) {
                    // Retry after a short delay
                    setTimeout(initConnection, 500);
                } else {
                    // Show message if not embedded in HA frontend
                    document.getElementById('content').innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: var(--secondary-text-color, #757575);">
                            <h2 style="margin-bottom: 20px;">‚ö†Ô∏è Not Embedded in Home Assistant</h2>
                            <p style="margin-bottom: 15px;">This panel should be accessed via the Home Assistant sidebar.</p>
                            <p style="margin-bottom: 15px;">To add it to the sidebar:</p>
                            <ol style="text-align: left; max-width: 500px; margin: 0 auto;">
                                <li style="margin-bottom: 10px;">Go to <strong>Settings ‚Üí Dashboards</strong></li>
                                <li style="margin-bottom: 10px;">Click <strong>Add Dashboard</strong></li>
                                <li style="margin-bottom: 10px;">Select <strong>Panel (sidebar)</strong></li>
                                <li style="margin-bottom: 10px;">Set URL to <code>/pill_assistant/pill-assistant-panel.html</code></li>
                                <li style="margin-bottom: 10px;">Set title to <strong>Pill Assistant</strong></li>
                                <li style="margin-bottom: 10px;">Set icon to <strong>mdi:pill</strong></li>
                            </ol>
                        </div>
                    `;
                }
            }
        }

        // Load medications from Home Assistant
        async function loadMedications() {
            try {
                if (!hass) {
                    hass = getHassConnection();
                    if (!hass) {
                        throw new Error('Home Assistant connection not available');
                    }
                }

                // Get all entities
                const states = hass.states;
                medications = [];

                // Filter for pill assistant sensors
                for (const entityId in states) {
                    if (entityId.startsWith('sensor.pa_')) {
                        const entity = states[entityId];
                        medications.push({
                            entityId: entityId,
                            state: entity.state,
                            attributes: entity.attributes
                        });
                    }
                }

                renderMedications();
            } catch (error) {
                console.error('Error loading medications:', error);
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> Failed to load medications. ${error.message}
                    </div>
                `;
            }
        }

        // Render medications
        function renderMedications() {
            const content = document.getElementById('content');

            if (medications.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M4.22,11.29L11.29,4.22C13.64,1.88 17.43,1.88 19.78,4.22C22.12,6.56 22.12,10.36 19.78,12.71L12.71,19.78C10.36,22.12 6.56,22.12 4.22,19.78C1.88,17.43 1.88,13.64 4.22,11.29M5.64,12.71C4.59,13.75 4.24,15.24 4.6,16.57L10.59,10.59L14.83,14.83L18.36,11.29C19.93,9.73 19.93,7.2 18.36,5.64C16.8,4.07 14.27,4.07 12.71,5.64L5.64,12.71Z" />
                        </svg>
                        <h2>No Medications Found</h2>
                        <p>Add medications through Settings ‚Üí Devices & Services ‚Üí Add Integration ‚Üí Pill Assistant</p>
                    </div>
                `;
                return;
            }

            let html = '';
            medications.forEach(med => {
                html += renderMedicationCard(med);
            });

            content.innerHTML = html;
        }

        // Render individual medication card
        function renderMedicationCard(med) {
            const attrs = med.attributes;
            const medId = attrs['Medication ID'] || attrs['medication_id'] || '';
            const dosage = attrs['dosage'] || attrs['Dosage'] || '1';
            const dosageUnit = attrs['dosage_unit'] || attrs['Dosage unit'] || 'pill(s)';
            const remaining = attrs['remaining_amount'] || attrs['Remaining amount'] || 0;
            const lastTaken = formatTimeToLocal(attrs['Last taken at'] || attrs['last_taken'] || 'Never');
            const schedule = formatSchedule(attrs['Schedule'] || 'Not scheduled');
            const nextDose = formatTimeToLocal(attrs['Next dose time'] || 'Unknown');
            const refillAmount = attrs['Refill amount'] || 0;
            const medName = med.entityId.replace('sensor.pa_', '').replace(/_/g, ' ');
            
            // Helper to check if decrement button should be disabled
            const isDecrementDisabled = parseFloat(dosage) <= 0.5;
            const isRemainingDecrementDisabled = parseFloat(remaining) <= 0;

            return `
                <div class="medication-card" data-entity-id="${med.entityId}">
                    <div class="medication-header">
                        <div class="medication-name">${medName}</div>
                        <div class="medication-status status-${med.state}">${med.state}</div>
                    </div>

                    <div class="medication-details">
                        <div class="detail-item">
                            <div class="detail-label">Schedule</div>
                            <div class="detail-value">${schedule}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Remaining Amount</div>
                            <div class="detail-value">${remaining} ${dosageUnit}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Last Taken</div>
                            <div class="detail-value">${lastTaken}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Next Dose</div>
                            <div class="detail-value">${nextDose}</div>
                        </div>
                    </div>

                    <div class="adjusters-container">
                        <div class="dosage-adjuster">
                            <div class="dosage-label">Dosage:</div>
                            <div class="dosage-controls">
                                <button class="dosage-btn" onclick="adjustDosage('${medId}', -1)" ${isDecrementDisabled ? 'disabled' : ''}>‚àí</button>
                                <div class="dosage-value">${dosage} ${dosageUnit}</div>
                                <button class="dosage-btn" onclick="adjustDosage('${medId}', 1)">+</button>
                            </div>
                        </div>

                        <div class="dosage-adjuster">
                            <div class="dosage-label">Remaining:</div>
                            <div class="dosage-controls">
                                <button class="dosage-btn" onclick="adjustRemaining('${medId}', -1)" ${isRemainingDecrementDisabled ? 'disabled' : ''}>‚àí</button>
                                <div class="dosage-value">${remaining} ${dosageUnit}</div>
                                <button class="dosage-btn" onclick="adjustRemaining('${medId}', 1)">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn btn-take" onclick="takeMedication('${medId}')">
                            Mark as Taken
                        </button>
                        <button class="action-btn btn-skip" onclick="skipMedication('${medId}')">
                            Skip Dose
                        </button>
                        <button class="action-btn btn-refill" onclick="refillMedication('${medId}')">
                            Refill
                        </button>
                        <button class="action-btn btn-test" onclick="testNotification('${medId}')">
                            Test Notification
                        </button>
                    </div>

                    <div class="card-management-actions">
                        <button class="action-btn btn-edit" onclick="editMedication('${medId}')">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteMedication('${medId}', '${medName}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `;
        }

        // Call Home Assistant service
        async function callService(domain, service, serviceData) {
            try {
                if (!hass) {
                    hass = getHassConnection();
                    if (!hass) {
                        throw new Error('Home Assistant connection not available');
                    }
                }

                // Mark card as updating using exact entity ID match
                const medId = serviceData.medication_id;
                const targetCard = findMedicationCard(medId);
                
                if (targetCard) {
                    targetCard.classList.add('updating');
                }

                await hass.callService(domain, service, serviceData);
                showSuccessMessage(`Action completed successfully!`);
                
                // Immediately reload medications for instant feedback
                await loadMedications();
                
                // Remove updating class
                if (targetCard) {
                    targetCard.classList.remove('updating');
                }
            } catch (error) {
                console.error('Error calling service:', error);
                showErrorMessage(`Error: ${error.message}`);
                
                // Remove updating class on error
                const medId = serviceData.medication_id;
                const errorCard = findMedicationCard(medId);
                if (errorCard) {
                    errorCard.classList.remove('updating');
                }
            }
        }

        // Show success message
        function showSuccessMessage(message) {
            showNotification(message, 'success');
        }

        // Show error message
        function showErrorMessage(message) {
            showNotification(message, 'error');
        }

        // Show notification message
        function showNotification(message, type = 'success') {
            const msgEl = document.createElement('div');
            msgEl.className = type === 'error' ? 'error-message' : 'success-message';
            msgEl.textContent = message;
            document.body.appendChild(msgEl);

            setTimeout(() => {
                msgEl.remove();
            }, 3000);
        }

        // Medication actions
        async function takeMedication(medId) {
            await callService('pill_assistant', 'take_medication', { medication_id: medId });
        }

        async function skipMedication(medId) {
            await callService('pill_assistant', 'skip_medication', { medication_id: medId });
        }

        async function refillMedication(medId) {
            await callService('pill_assistant', 'refill_medication', { medication_id: medId });
        }

        async function testNotification(medId) {
            await callService('pill_assistant', 'test_notification', { medication_id: medId });
        }

        async function adjustDosage(medId, change) {
            const service = change > 0 ? 'increment_dosage' : 'decrement_dosage';
            await callService('pill_assistant', service, { medication_id: medId });
        }

        async function adjustRemaining(medId, change) {
            const service = change > 0 ? 'increment_remaining' : 'decrement_remaining';
            await callService('pill_assistant', service, { medication_id: medId });
        }

        // Add medication - opens config flow
        async function addMedication() {
            try {
                if (!hass) {
                    throw new Error('Home Assistant connection not available');
                }

                // Navigate to the config flow for adding a new medication
                const domain = 'pill_assistant';
                
                // Use Home Assistant's showConfigFlowDialog method if available
                if (window.parent && window.parent.document) {
                    const haElement = window.parent.document.querySelector('home-assistant');
                    if (haElement && haElement.provideHass) {
                        // Fire an event to open the config flow
                        window.parent.dispatchEvent(new CustomEvent('hass-more-info', {
                            detail: { 
                                action: 'show-dialog',
                                dialogTag: 'dialog-add-integration',
                                dialogImport: () => import('@/dialogs/config-flow/show-dialog-data-entry-flow'),
                                dialogParams: {
                                    domain: domain,
                                }
                            }
                        }));
                        
                        // Alternative: navigate to integrations page
                        window.parent.location.href = `/config/integrations/dashboard/add?domain=${domain}`;
                    }
                }
            } catch (error) {
                console.error('Error adding medication:', error);
                showErrorMessage(`Error: ${error.message}. Please add medication through Settings ‚Üí Devices & Services ‚Üí Add Integration ‚Üí Pill Assistant`);
            }
        }

        // Edit medication - opens options flow
        async function editMedication(medId) {
            try {
                if (!hass) {
                    throw new Error('Home Assistant connection not available');
                }

                // Navigate to the options flow for this medication
                if (window.parent) {
                    // Navigate to the config entry options page
                    window.parent.location.href = `/config/integrations/integration/pill_assistant/entry/${medId}`;
                }
            } catch (error) {
                console.error('Error editing medication:', error);
                showErrorMessage(`Error: ${error.message}. Please edit medication through Settings ‚Üí Devices & Services ‚Üí Configure`);
            }
        }

        // Delete medication - removes config entry
        async function deleteMedication(medId, medName) {
            try {
                if (!hass) {
                    throw new Error('Home Assistant connection not available');
                }

                // Confirm deletion
                if (!confirm(`Are you sure you want to delete ${medName}? This will remove all data for this medication.`)) {
                    return;
                }

                // Call the config_entries.remove service
                await hass.callService('config_entries', 'remove', {
                    entry_id: medId
                });
                
                showSuccessMessage(`${medName} deleted successfully!`);
                
                // Reload medications
                await loadMedications();
            } catch (error) {
                console.error('Error deleting medication:', error);
                showErrorMessage(`Error deleting medication: ${error.message}`);
            }
        }

        // Initialize on load
        initConnection();

        // Subscribe to Home Assistant state changes for real-time updates
        function subscribeToStateChanges() {
            if (!hass) {
                return false;
            }

            // Subscribe to state changes using hass connection
            if (hass.connection && hass.connection.subscribeEvents) {
                hass.connection.subscribeEvents(
                    (event) => {
                        // Check if the changed entity is a pill assistant sensor
                        if (event.data && event.data.entity_id && 
                            event.data.entity_id.startsWith('sensor.pa_')) {
                            console.log('Pill Assistant state changed:', event.data.entity_id);
                            loadMedications();
                        }
                    },
                    'state_changed'
                ).catch(err => {
                    console.warn('Failed to subscribe to state changes:', err);
                });
                return true;
            }
            return false;
        }

        // Try to subscribe with retry logic
        let subscribeAttempts = 0;
        function attemptSubscription() {
            if (subscribeAttempts >= SUBSCRIPTION_MAX_ATTEMPTS) {
                console.warn(`Failed to subscribe to state changes after ${SUBSCRIPTION_MAX_ATTEMPTS} attempts`);
                return;
            }
            
            subscribeAttempts++;
            if (!subscribeToStateChanges()) {
                // Retry with exponential backoff
                const delay = Math.min(
                    SUBSCRIPTION_BASE_DELAY_MS * subscribeAttempts, 
                    SUBSCRIPTION_MAX_DELAY_MS
                );
                setTimeout(attemptSubscription, delay);
            } else {
                console.log('Successfully subscribed to state changes');
            }
        }
        
        // Start subscription attempts after connection is ready
        attemptSubscription();

        // Refresh medications every 30 seconds as fallback
        setInterval(() => {
            if (hass) {
                loadMedications();
            }
        }, POLL_INTERVAL_MS);
    </script>
</body>
</html>
